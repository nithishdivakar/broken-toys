<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
	font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
margin: auto;
position: relative;
width: 960px;
background-color:rgb(89,86,86);;
}

form {
position: absolute;
right: 10px;
top: 10px;
}

path {
stroke: #fff;
		fill-rule: evenodd;
}

</style>
<body>
<!--form>
<label><input type="radio" name="mode" value="size"  > Size</label>
<label><input type="radio" name="mode" value="count" checked> Count</label>
</form-->
<!--<script src="http://d3js.org/d3.v3.min.js"></script> -->
<script src="d3.v3.min.js"></script>
<script>



var DATA = {
name:"Routine",
	 children:[
	 {"name": "sleep","start":6,"end":8},
	 {"name": "morning","size":8},
	 {"name": "AfterNoon nap"     ,"size":1},
	 {"name": "evening","size":4},
	 {"name": "nap"   ,"size": 1},
	 {"name": "night","size":4}
	 ]
};

var DATA = {
name:"Routine",
	 children:[
	 {"level":1,"item":1, "name": "Su","start":0,"end":24},
	 {"level":1,"item":2, "name": "Mo","start":0,"end":24},
	 {"level":1,"item":3, "name": "Tu","start":0,"end":24},
	 {"level":1,"item":4, "name": "We","start":0,"end":24},
	 {"level":1,"item":5, "name": "Th","start":0,"end":24},
	 {"level":1,"item":6, "name": "Fr","start":0,"end":24},
	 {"level":1,"item":7, "name": "Sa","start":0,"end":24},
	 //{"level":2,"item":2 ,"name": "work","start":9,"end":17},
	 {"level":2,"item":2 ,"name": "work","start":10,"end":18},
	 {"level":2,"item":3 ,"name": "work","start":10,"end":18},
	 {"level":2,"item":4 ,"name": "work","start":10,"end":18},
	 {"level":2,"item":5 ,"name": "work","start":10,"end":18},
	 {"level":2,"item":6 ,"name": "work","start":10,"end":18},
	 {"level":2,"item":7 ,"name": "work","start":10,"end":18},


	 {"level":3,"item":1 ,"name": "sleep","start":10,"end":22},//
	 {"level":3,"item":2 ,"name": "sleep","start":14,"end":22},//
	 {"level":3,"item":3 ,"name": "sleep","start":18,"end":24},
	 {"level":3,"item":4 ,"name": "sleep","start":0,"end":2},
	 {"level":3,"item":4 ,"name": "sleep","start":22,"end":24},
	 {"level":3,"item":5 ,"name": "sleep","start":0,"end":6},
	 {"level":3,"item":6 ,"name": "sleep","start":2,"end":10},
	 {"level":3,"item":7 ,"name": "sleep","start":2,"end":10},//<

	 {"level":3,"item":1 ,"name": "wake","start": 0,"end":14},
	 {"level":3,"item":1 ,"name": "wake","start":22,"end":24},//
	 {"level":3,"item":2 ,"name": "wake","start":0,"end":14},//
	 {"level":3,"item":2 ,"name": "wake","start":22,"end":24},
	 {"level":3,"item":3 ,"name": "wake","start":0,"end":18},
	 {"level":3,"item":4 ,"name": "wake","start":2,"end":22},
	 {"level":3,"item":5 ,"name": "wake","start":6,"end":24},
	 {"level":3,"item":6 ,"name": "wake","start":0,"end":2},
	 {"level":3,"item":6 ,"name": "wake","start":10,"end":24},
	 {"level":3,"item":7 ,"name": "wake","start":0,"end":2},
	 {"level":3,"item":7 ,"name": "wake","start":10,"end":24},//
	 /*
	 {"level":3,"item":1 ,"name": "sleep","start":0,"end":8},
	 {"level":3,"item":2 ,"name": "sleep","start":7,"end":15},
	 {"level":3,"item":3 ,"name": "sleep","start":8,"end":16},
	 {"level":3,"item":4 ,"name": "sleep","start":12,"end":20},
	 {"level":3,"item":5 ,"name": "sleep","start":16,"end":24},
	 {"level":3,"item":6 ,"name": "sleep","start":20,"end":24},
	 {"level":3,"item":7 ,"name": "sleep","start":0,"end":1},
	 {"level":3,"item":1 ,"name": "wake","start":8,"end":24},
	 {"level":3,"item":2 ,"name": "wake","start":0,"end":7},
	 {"level":3,"item":2 ,"name": "wake","start":15,"end":24},
	 {"level":3,"item":3 ,"name": "wake","start":0,"end":8},
	 {"level":3,"item":3 ,"name": "wake","start":16,"end":24},
	 {"level":3,"item":4 ,"name": "wake","start":0,"end":12},
	 {"level":3,"item":4 ,"name": "wake","start":20,"end":24},
	 {"level":3,"item":5 ,"name": "wake","start":0,"end":16},
	 {"level":3,"item":6 ,"name": "wake","start":0,"end":20},
	 {"level":3,"item":7 ,"name": "wake","start":1,"end":24},
*/
/*
	 {"level":4,"item":1,"start":0,"end":6},
	 {"level":4,"item":2,"start":0,"end":6},
	 {"level":4,"item":3,"start":0,"end":6},
	 {"level":4,"item":4,"start":0,"end":6},
	 {"level":4,"item":5,"start":0,"end":6},
	 {"level":4,"item":6,"start":0,"end":6},
	 {"level":4,"item":7,"start":0,"end":6},


	 {"level":4,"item":1,"start":6,"end":12},
	 {"level":4,"item":2,"start":6,"end":12},
	 {"level":4,"item":3,"start":6,"end":12},
	 {"level":4,"item":4,"start":6,"end":12},
	 {"level":4,"item":5,"start":6,"end":12},
	 {"level":4,"item":6,"start":6,"end":12},
	 {"level":4,"item":7,"start":6,"end":12},


	 {"level":4,"item":1,"start":12,"end":18},
	 {"level":4,"item":2,"start":12,"end":18},
	 {"level":4,"item":3,"start":12,"end":18},
	 {"level":4,"item":4,"start":12,"end":18},
	 {"level":4,"item":5,"start":12,"end":18},
	 {"level":4,"item":6,"start":12,"end":18},
	 {"level":4,"item":7,"start":12,"end":18},

	 {"level":4,"item":1,"start":18,"end":24},
	 {"level":4,"item":2,"start":18,"end":24},
	 {"level":4,"item":3,"start":18,"end":24},
	 {"level":4,"item":4,"start":18,"end":24},
	 {"level":4,"item":5,"start":18,"end":24},
	 {"level":4,"item":6,"start":18,"end":24},
	 {"level":4,"item":7,"start":18,"end":24},
	 */
	 ]
};

var width = 960,
	height = 700,
	radius = Math.min(width, height) / 2-50;

var TO = Math.PI + Math.PI/2;//Math.PI/6;
var Clock_radius = radius+26;
var Clock_thickness = 6;

var x = d3.scale.linear()
	.range([0, 2 * Math.PI]);

var y = d3.scale.sqrt()
	.range([0, radius]);

	var color = d3.scale.category20c();

	var svg = d3.select("body").append("svg")
	.attr("width", width)
	.attr("height", height)
	.append("g")
	.attr("transform", "translate(" + width / 2 + "," + (height / 2 + 10) + ")");

/*	var partition = d3.layout.partition()
.sort(null)
	.value(function(d) { return d.size; });
*/

var partition = d3.layout.partition()
	.sort(function(d1,d2){return d1.start>d2.start;})
	.value(function(d) { return d.end-d.start; });

function o(d){
	if(d.level==3)
		return +0;//+10;
	if(d.level==2)
		return -0;
	if(d.level==1)
		return 0;//-12+3.5*24;
	
	return 0;
}

var arc = d3.svg.arc()
	.startAngle( function(d) { return x(((d.item-1)*24+d.start+o(d))/(24*7));/*Math.max(0, Math.min(2 * Math.PI, x(d.x)));*/ })
	.endAngle(   function(d) { return x(((d.item-1)*24+d.end+o(d))/(24*7)) })
	.innerRadius(function(d) { return y(0.1*d.level);/*Math.max(0, y(d.y));*/ })
	.outerRadius(function(d) { return y(0.1*d.level+0.1);/*Math.max(0, y(d.y + d.dy));*/ });

var arcClock = d3.svg.arc()
	.startAngle( function(d) { return (d.start)/(24*60*60)*2*Math.PI  /*+TO*/;  })
	.endAngle(   function(d) { return (d.end  )/(24*60*60)*2*Math.PI  /*+TO*/; })
	.innerRadius(function(d) { return Clock_radius;})
	.outerRadius(function(d) { return Clock_radius+Clock_thickness;});


	var Clock = svg.append("g")
	.attr("id","Clock");
	var SolarFlareGroup = svg.append("g")
	.attr("id","flare");

	// Keep track of the node that is currently being displayed as the root.
	var node;

	//d3.json("flare.json", function(error, root) {
	//		node = DATA;
	node = DATA;
	root = DATA;

	/////
	//var g = svg.datum(DATA).selectAll("g")
	var g=SolarFlareGroup.datum(DATA).selectAll("g")
.data(partition.nodes)
	.enter().append("svg:g")
	.on("click",click)
	;


	var path = g.append("svg:path")
	.attr("d", arc)
	.attr("stroke", "#fff")
	//.attr("fill", function(d) { return color((d.children ? d : d.parent).name); })
	.attr("fill", function(d) { if(d.name=="wake") return "#77f"; else if(d.name=="sleep") return "#eee"; return color(Math.random()); })
	.attr("fill-rule", "evenodd")
	.attr("id",function(d){return d.name;})
.each(stash)
	;

	var text = g.append("svg:text")
	.attr("transform", function(d) { 
			angle = Angle(d.x,d.dx);
			return "rotate(" + angle + ")";
			})
	.attr("x", function(d) { return y(d.y); })
	.attr("dx", x(0)) // margin
	.attr("dy", ".2em") // vertical-align
	.attr("style","font-size:xx-small;z-index:10000")
	.attr("id", function(d){ return d.name; })
	.text(function(d) { return d.name; })
	.each(stash)
	;
	///////

//	Clock.append("g");
Clock.append("path").attr("id","completed");
Clock.append("path").attr("id","notcompleted");
Clock.append("g").attr("id","time-group");

Clock.select("g#time-group").append("circle").attr("id","time");
Clock.select("g#time-group").append("text").attr("id","timeshower");

//d3.timer(function() {
setInterval(function(){
	var X = timeOfDay();
	H    = X["hour"];
	M    = X["minute"];
	S    = X["second"];
	TIME = X["tot_sec"];
	//console.log(X);
	var Data = [{"start":0,"end":TIME},{"start":TIME,"end":24*60*60-1}];

	Clock.selectAll("path")
		.data(Data)
		.attr("d",arcClock)
		.attr("stroke","rgba(0,0,0,0)")
		.attr("style","stroke:rgba(0,0,0,0)")
		.attr("fill", function(d) { if(d.start ==0) return "#999"; else return "#111"; })
		.attr("fill-rule","nonzero")
		.attr("fill-opacity","0.4")
		;
	
	Clock.select("g#time-group")
	.attr("transform",function(d){
		Q = (TIME)/(24*60*60)*2*Math.PI  -Math.PI/2;
		R = Clock_radius+Clock_thickness/2;
		return "translate(" +R*Math.cos(Q)+ "," +R*Math.sin(Q) +")";
	})
	;


	Clock.selectAll("circle")
	.attr("r",12)
	.attr("fill", "#fff");

	Clock.selectAll("text")
	.text(""+H+":"+M)
	.attr("transform",function(d){
		return "translate(-11,3)";
	})
	.attr("style","font-size:xx-small")
	;

},5000);

function timeOfDay(){
   d = new Date;
    var second = (d.getSeconds() ),
        minute = (d.getMinutes() ) ,
        hour = (d.getHours()) ;
   var secondOftheDay = hour*60*60 + minute*60 + second;
   //secondOftheDay=(secondOftheDay*1000)%(24*60*60);
   return {"hour":hour, "minute":minute, "second":second,"tot_sec":secondOftheDay};
 }

d3.selectAll("input").on("change", function change() {
		var value = this.value === "count"
		? function() { return 1; }
		: function(d) { return d.size; };

		path
		.data(partition.value(value).nodes)
		.transition()
		.duration(1000)
		.attrTween("d", arcTweenData);

		text
		.data(partition.value(value).nodes)
		.transition()
		.duration(1000)
		.attrTween("transform", function(d,i){
				angle0 = Angle(d.x0,d.dx0);
				angle = Angle(d.x,d.dx);
				return d3.interpolateString("rotate("+angle0+")","rotate("+angle+")");
				})
		;
});

function click(d) {
	node = d;
	path.transition()
		.duration(1000)
		.attrTween("d", arcTweenZoom(d));

	text
		.transition()
		.duration(1000)
		.attrTween("x", arcTweenZoom2(d))
		.attrTween("transform", arcTweenZoom3(d))
		;
}

function Angle(dx, ddx){
	sA =  Math.max(0, Math.min(2 * Math.PI, x(dx))); 
	eA =  Math.max(0, Math.min(2 * Math.PI, x(dx + ddx)));

	angle = (sA+eA)/2 / Math.PI*180 -90;
	/*
	   angle is in radians but css rotation takes degrees. + there is a 90 degree offset. 
	 */
	return angle;
}


d3.select(self.frameElement).style("height", height + "px");

// Setup for switching data: stash the old values for transition.
function stash(d) {
	d.x0 = d.x;
	d.dx0 = d.dx;
	d.y0 = d.y;
	d.dy0 = d.dy;
}

// When switching data: interpolate the arcs in data space.
function arcTweenData(a, i) {
	var oi = d3.interpolate({x: a.x0, dx: a.dx0}, a);
	function tween(t) {
		var b = oi(t);
		a.x0 = b.x;
		a.dx0 = b.dx;
		return arc(b);
	}
	if (i == 0) {
		// If we are on the first arc, adjust the x domain to match the root node
		// at the current zoom level. (We only need to do this once.)
		var xd = d3.interpolate(x.domain(), [node.x, node.x + node.dx]);
		return function(t) {
			x.domain(xd(t));
			return tween(t);
		};
	} else {
		return tween;
	}
}

// When zooming: interpolate the scales.
function arcTweenZoom(d) {
	var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
		yd = d3.interpolate(y.domain(), [d.y, 1]),
		yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
	return function(d, i) {
		return i
			? function(t) { return arc(d); }
		: function(t) { x.domain(xd(t)); y.domain(yd(t)).range(yr(t)); return arc(d); };
	};
}
function arcTweenZoom2(d) {
	var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
		yd = d3.interpolate(y.domain(), [d.y, 1]),
		yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
	return function(d, i) {
		return i
			? function(t) { return y(d.y); }
		: function(t) { x.domain(xd(t)); y.domain(yd(t)).range(yr(t)); return y(d.y); };
	};
}

function arcTweenZoom3(d) {
	var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
		yd = d3.interpolate(y.domain(), [d.y, 1]),
		yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
	return function(d, i) {
		return i
			? function(t) { return "rotate("+Angle(d.x,d.dx)+")";}
		: function(t) { x.domain(xd(t)); y.domain(yd(t)).range(yr(t)); return "rotate("+Angle(d.x,d.dx)+")"; };
	};
}



</script>

